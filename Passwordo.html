<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passwordo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ... (Keep existing CSS styles) ... */
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background: #84b5e7; color: #333; line-height: 1.6; }
        .lock-icon{ height: 40px; width: 40px; padding-top: 5px;}
        header { background: #1e3a5f; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { font-family: 'Montserrat', sans-serif; margin: 0; }
        .nav { display: flex; gap: 20px; align-items: center; }
        .nav a { color: white; text-decoration: none; font-weight: 500; }
        .nav a:hover { text-decoration: underline; }
        .search-bar { display: flex; gap: 10px; margin: 20px 0; }
        .search-bar input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .search-bar select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .product { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .product:hover { transform: translateY(-5px); }
        .product img { width: 100%; height: 200px; object-fit: cover; border-radius: 5px; }
        .product h3 { margin: 10px 0; font-family: 'Montserrat', sans-serif; }
        .product p { margin: 5px 0; }
        button { background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
        button:hover { background: #218838; }
        .cart { position: fixed; top: 70px; right: 10px; background: white; padding: 15px; border: 1px solid #ddd; border-radius: 10px; width: 300px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
        .cart-item button { padding: 5px 10px; font-size: 12px; }
        .login, .profile, .forgot, .admin { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border: 1px solid #ddd; border-radius: 10px; width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .login input, .profile input, .forgot input, .admin input, .admin select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; font-size: 14px; margin-top: 5px; }
        
        /* --- General Popup Styles --- */
        .popup-base {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 350px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }

        .popup-base h3 {
            margin-top: 0;
            color: #1e3a5f;
            font-family: 'Montserrat', sans-serif;
        }

        .payment-options, .crypto-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .payment-options button, .crypto-options button {
            background: #1e3a5f;
            color: white;
            padding: 12px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .payment-options button:hover, .crypto-options button:hover {
            background: #28a745;
        }

        .close-popup {
            background: #dc3545;
            margin-top: 10px;
        }

        /* Styling for the specific popups */
        #paymentMethodPopup { z-index: 2000; }
        #binanceCryptoPopup { z-index: 2001; }
        #trustWalletCryptoPopup { z-index: 2002; /* Highest Z-index for the newest popup */ }


        /* --- FOOTER STYLES --- (Retained for completeness) */
        .custom-website-footer {
            background-color: #1e3a5f; 
            color: #f0f0f0; 
            padding: 40px 5% 20px 5%;
            font-family: 'Roboto', sans-serif;
            box-sizing: border-box;
            margin-top: 40px; 
        }

        .footer-links-container {
            display: flex;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto 30px auto;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 30px;
            flex-wrap: wrap; 
        }

        .footer-section {
            min-width: 180px; 
            padding: 0 10px;
        }

        .footer-section h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 15px;
            color: white;
            font-family: 'Montserrat', sans-serif;
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-section ul li {
            margin-bottom: 8px;
        }

        .footer-section ul li a {
            color: #c0b0e9; 
            text-decoration: none;
            font-size: 13px;
            transition: color 0.2s;
        }

        .footer-section ul li a:hover {
            color: white;
        }

        .social-icons a {
            color: white;
            font-size: 20px;
            margin-right: 15px;
            transition: opacity 0.2s;
        }

        .social-icons a:hover {
            opacity: 0.8;
        }

        .footer-bottom-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            font-size: 13px;
            padding: 10px 0;
        }

        .footer-logo-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .footer-logo-info h1 {
            margin: 0;
        }

        .footer-logo-info p {
            margin: 0;
            color: #c0b0e9;
            font-size: 12px;
        }

        .copyright-text {
            color: #c0b0e9;
            margin: 0;
        }
        
        .footer-logo-info .lock-icon {
            height: 25px !important; 
            width: 25px !important;
            padding-top: 0 !important; 
            vertical-align: middle; 
        }


        .email-us-button {
            background: #28a745; 
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            text-transform: uppercase;
            font-size: 13px; 
        }

        .email-us-button:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <header>
    <h1><img src="anonymous.png" alt="Lock Icon" class="lock-icon">Passwordo</h1>
        <nav class="nav">
            <a href="#" onclick="showLogin()">Login/Signup</a>
            <a href="#" onclick="showCart()">Cart (0)</a>
            <a href="#" onclick="showProfile()">Profile</a>
            <a href="#" onclick="showAdmin()">Admin</a>
        </nav>
    </header>

    <div class="search-bar" style="max-width: 1200px; margin: 20px auto; padding: 0 20px;">
        <input type="text" id="search" placeholder="Search products..." onkeyup="filterProducts()">
        <select id="categoryFilter" onchange="filterProducts()">
            <option value="">All Categories</option>
            <option value="Electronics">Electronics</option>
            <option value="Security">Security</option>
            <option value="Accessories">Accessories</option>
        </select>
    </div>

    <div class="products" id="productsContainer">
    </div>

    <div class="cart" id="cart">
        <h3>Your Cart</h3>
        <div id="cartItems">Cart is empty.</div>
        <p id="cartTotal">Total: $0.00</p>
        <button onclick="checkout()">Checkout with Stripe</button>
    </div>

    <div id="paymentMethodPopup" class="popup-base">
        <h3>Item Added to Cart!</h3>
        <p>Would you like to explore alternative payment methods now, or continue shopping?</p>
        <div class="payment-options">
            <button onclick="showBinanceCryptoPopup()">
                <i class="fas fa-money-check-alt"></i> Pay with **Binance**
            </button>
            <button onclick="showTrustWalletCryptoPopup()">
                <i class="fas fa-wallet"></i> Pay with **Trust Wallet**
            </button>
            <button onclick="alert('Proceeding with PayPal Payment (Simulated)'); closePaymentPopup();">
                <i class="fab fa-paypal"></i> Pay with PayPal
            </button>
        </div>
        <button class="close-popup" onclick="closePaymentPopup()">Continue Shopping</button>
    </div>
    <div id="binanceCryptoPopup" class="popup-base">
        <h3>Binance: Select Cryptocurrency</h3>
        <p>Choose your preferred coin to complete the payment:</p>
        <div class="crypto-options">
            <button onclick="processBinancePayment('Bitcoin')"><i class="fab fa-btc"></i> Bitcoin (BTC)</button>
            <button onclick="processBinancePayment('USDT')"><i class="fas fa-dollar-sign"></i> Tether (USDT)</button>
            <button onclick="processBinancePayment('USDC')"><i class="fas fa-dollar-sign"></i> USD Coin (USDC)</button>
            <button onclick="processBinancePayment('PEPE')">üê∏ Pepe (PEPE)</button>
            <button onclick="processBinancePayment('Solana')"><i class="fas fa-sun"></i> Solana (SOL)</button>
        </div>
        <button onclick="closeBinanceCryptoPopup()">Back to Payment Options</button>
    </div>
    <div id="trustWalletCryptoPopup" class="popup-base">
        <h3>Trust Wallet: Select Cryptocurrency</h3>
        <p>Choose your preferred coin to complete the payment:</p>
        <div class="crypto-options">
            <button onclick="processTrustWalletPayment('Bitcoin')"><i class="fab fa-btc"></i> Bitcoin (BTC)</button>
            <button onclick="processTrustWalletPayment('USDT')"><i class="fas fa-dollar-sign"></i> Tether (USDT)</button>
            <button onclick="processTrustWalletPayment('USDC')"><i class="fas fa-dollar-sign"></i> USD Coin (USDC)</button>
            <button onclick="processTrustWalletPayment('PEPE')">üê∏ Pepe (PEPE)</button>
            <button onclick="processTrustWalletPayment('Solana')"><i class="fas fa-sun"></i> Solana (SOL)</button>
        </div>
        <button onclick="closeTrustWalletCryptoPopup()">Back to Payment Options</button>
    </div>
    <div class="login" id="login">
        <h2>Login/Signup</h2>
        <input type="email" placeholder="Email" id="email">
        <input type="password" placeholder="Password" id="password">
        <input type="text" placeholder="Display Name (for Signup)" id="displayName" style="display: none;">
        <div id="loginError" class="error"></div>
        <button id="loginSignupBtn" onclick="handleLoginSignup()">Login</button>
        <button onclick="toggleSignup()">Signup Mode</button>
        <button onclick="closeLogin()">Close</button>
        <p><a href="#" onclick="showForgot()">Forgot Password?</a></p>
    </div>

    <div class="forgot" id="forgot">
        <h2>Forgot Password</h2>
        <input type="email" placeholder="Enter your email" id="resetEmail">
        <input type="text" placeholder="Reset Token (from email)" id="resetToken" style="display: none;">
        <input type="password" placeholder="New Password" id="newPassword" style="display: none;">
        <div id="forgotError" class="error"></div>
        <button onclick="requestReset()">Send Reset Link</button>
        <button onclick="resetPassword()" style="display: none;" id="resetBtn">Reset Password</button>
        <button onclick="closeForgot()">Close</button>
    </div>

    <div class="profile" id="profile">
        <h2>Your Profile</h2>
        <p id="profileInfo">Not logged in.</p>
        <input type="text" placeholder="Update Display Name" id="updateName">
        <button onclick="updateProfile()">Update</button>
        <button onclick="logout()">Logout</button>
        <button onclick="closeProfile()">Close</button>
    </div>

    <div class="admin" id="admin">
        <h2>Add New Product</h2>
        <input type="text" placeholder="Product Name" id="adminName">
        <input type="number" step="0.01" placeholder="Price" id="adminPrice">
        <select id="adminCategory">
            <option value="Electronics">Electronics</option>
            <option value="Security">Security</option>
            <option value="Accessories">Accessories</option>
        </select>
        <input type="url" placeholder="Image URL" id="adminImg">
        <textarea placeholder="Description" id="adminDesc" rows="3"></textarea>
        <div id="adminError" class="error"></div>
        <button onclick="addProduct()">Add Product</button>
        <button onclick="closeAdmin()">Close</button>
    </div>

        <footer class="custom-website-footer">
        <div class="footer-links-container">
                        <div class="footer-section">
                <h3>ABOUT US</h3>
                <ul>
                    <li><a href="#">PRESS ROOM</a></li>
                    <li><a href="#">Testimonials</a></li>
                    <li><a href="#">Careers</a></li>
                </ul>
            </div>

                        <div class="footer-section">
                <h3>CUSTOMERS</h3>
                <ul>
                    <li><a href="#">Return Policy</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms and Conditions</a></li>
                    <li><a href="#">Tech Support</a></li>
                    <li><a href="#">Documentation</a></li>
                </ul>
            </div>

                        <div class="footer-section">
                <h3>OTHER SERVICES</h3>
                <ul>
                    <li><a href="#">Affiliate Program</a></li>
                    <li><a href="#">Security Blog</a></li>
                </ul>
            </div>

                        <div class="footer-section social-links-section">
                <h3>FOLLOW US ON</h3>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-pinterest-p"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
        </div>

                <div class="footer-bottom-bar">
            <div class="footer-logo-info">
                <h1 style="color: white; font-size: 20px;"><img src="anonymous.png" alt="Lock Icon" class="lock-icon"> Passwordo</h1>
                <p>A **SecureTech** company</p>
            </div>
            
            <p class="copyright-text">
                &copy; 2018-2025 Passwordo. All Rights Reserved.
            </p>

            <button class="email-us-button" onclick="window.location.href='mailto:support@passwordo.com'">Email Us</button>
        </div>
    </footer>
    <script>
        const stripe = Stripe('pk_test_your_stripe_publishable_key_here'); // Replace with your Stripe publishable key
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let resetTokens = JSON.parse(localStorage.getItem('resetTokens')) || {}; // For demo reset tokens
        let products = JSON.parse(localStorage.getItem('products')) || [
            { id: 1, name: 'Secure Password Manager', price: 29.99, category: 'Security', img: 'https://images.unsplash.com/photo-1555949963-aa79dcee981c?w=400', desc: 'Store and generate strong passwords securely.' },
            { id: 2, name: 'Wireless Earbuds', price: 49.99, category: 'Electronics', img: 'https://images.unsplash.com/photo-1590658268037-6bf12165a8df?w=400', desc: 'High-quality sound with noise cancellation.' },
            { id: 3, name: 'Smart Lock', price: 79.99, category: 'Security', img: 'https://images.unsplash.com/photo-1558618666-fcd91fc51a46?w=400', desc: 'Keyless entry with app control.' },
            { id: 4, name: 'Laptop Stand', price: 39.99, category: 'Accessories', img: 'https://images.unsplash.com/photo-1527864550417-7fd91fc51a46?w=400', desc: 'Ergonomic stand for better posture.' },
            { id: 5, name: 'VPN Service Subscription', price: 9.99, category: 'Security', img: 'https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=400', desc: 'Protect your online privacy.' },
            { id: 6, name: 'Bluetooth Speaker', price: 59.99, category: 'Electronics', img: 'https://images.unsplash.com/photo-1608043152269-423dbba4e7e1?w=400', desc: 'Portable speaker with deep bass.' },
            { id: 7, name: 'Anti-Theft Backpack', price: 69.99, category: 'Accessories', img: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400', desc: 'Secure your valuables on the go.' },
            { id: 8, name: 'Fingerprint Scanner', price: 19.99, category: 'Security', img: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=400', desc: 'Biometric access control.' },
            { id: 9, name: 'Gaming Mouse', price: 34.99, category: 'Electronics', img: 'https://images.unsplash.com/photo-1527814050087-3793815479db?w=400', desc: 'Precision mouse for gamers.' },
            { id: 10, name: 'Cable Organizer', price: 14.99, category: 'Accessories', img: 'https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=400', desc: 'Keep your desk tidy.' },
            { id: 11, name: 'Encrypted USB Drive', price: 24.99, category: 'Security', img: 'https://images.unsplash.com/photo-1625842268584-8f3296236761?w=400', desc: 'Secure data storage.' },
            { id: 12, name: 'Wireless Charger', price: 19.99, category: 'Electronics', img: 'https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=400', desc: 'Fast charging for devices.' },
            { id: 13, name: 'Biometric Keyboard', price: 89.99, category: 'Security', img: 'https://images.unsplash.com/photo-1587825140708-dfaf72ae4b04?w=400', desc: 'Keyboard with built-in fingerprint reader.' },
            { id: 14, name: 'Surveillance Camera', price: 119.99, category: 'Security', img: 'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=400', desc: 'HD camera for home security monitoring.' },
            { id: 15, name: 'Portable Hard Drive', price: 54.99, category: 'Electronics', img: 'https://images.unsplash.com/photo-1606230960216-e18be2a5622e?w=400', desc: '1TB external storage for backups.' },
            { id: 16, name: 'Privacy Screen Protector', price: 12.99, category: 'Accessories', img: 'https://images.unsplash.com/photo-1515378791036-320f6b0c26a7?w=400', desc: 'Anti-glare screen filter for laptops.' },
            { id: 17, name: 'Two-Factor Authenticator', price: 15.99, category: 'Security', img: 'https://images.unsplash.com/photo-1563013544-824ae1b704d3?w=400', desc: 'Hardware token for secure logins.' },
            { id: 18, name: 'Smartphone Stand', price: 22.99, category: 'Accessories', img: 'https://images.unsplash.com/photo-1589492477829-5e65395b66cc?w=400', desc: 'Adjustable stand for hands-free viewing.' }
        ];

        function renderProducts(filtered = products) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = filtered.map(p => `
                <div class="product">
                    <img src="${p.img}" alt="${p.name}">
                    <h3>${p.name}</h3>
                    <p>${p.desc}</p>
                    <p>$${p.price.toFixed(2)}</p>
                    <button onclick="addToCart(${p.id})">Add to Cart</button>
                </div>
            `).join('');
        }

        function filterProducts() {
            const search = document.getElementById('search').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) && (!category || p.category === category)
            );
            renderProducts(filtered);
        }

        function showCart() { document.getElementById('cart').style.display = 'block'; updateCart(); }
        function showLogin() { 
            document.getElementById('login').style.display = 'block'; 
            document.getElementById('displayName').style.display = 'none'; // Reset to login view
            document.getElementById('loginSignupBtn').innerText = 'Login';
        }
        function closeLogin() { document.getElementById('login').style.display = 'none'; }
        function showForgot() { document.getElementById('forgot').style.display = 'block'; document.getElementById('login').style.display = 'none'; }
        function closeForgot() { document.getElementById('forgot').style.display = 'none'; }
        function showProfile() { 
            if (!currentUser) { alert('Please log in first.'); return; }
            document.getElementById('profile').style.display = 'block'; 
            document.getElementById('profileInfo').innerText = `Name: ${currentUser.displayName}, Email: ${currentUser.email}`;
        }
        function closeProfile() { document.getElementById('profile').style.display = 'none'; }
        function showAdmin() {
            const password = prompt('Enter admin password:');
            if (password === 'admin123') { // Change this password for security
                document.getElementById('admin').style.display = 'block';
            } else {
                alert('Incorrect password.');
            }
        }
        function closeAdmin() { document.getElementById('admin').style.display = 'none'; }

        // --- GENERAL POPUP FUNCTIONS ---
        function showPaymentPopup() {
            document.getElementById('paymentMethodPopup').style.display = 'block';
            // Ensure child popups are hidden
            document.getElementById('binanceCryptoPopup').style.display = 'none';
            document.getElementById('trustWalletCryptoPopup').style.display = 'none';
        }

        function closePaymentPopup() {
            document.getElementById('paymentMethodPopup').style.display = 'none';
        }
        // --- END GENERAL POPUP FUNCTIONS ---


        // --- BINANCE CRYPTO POPUP FUNCTIONS ---
        function showBinanceCryptoPopup() {
            closePaymentPopup(); // Hide the first popup
            document.getElementById('binanceCryptoPopup').style.display = 'block';
        }

        function closeBinanceCryptoPopup() {
            document.getElementById('binanceCryptoPopup').style.display = 'none';
            showPaymentPopup(); // Go back to the main payment options
        }

        function processBinancePayment(currency) {
            const total = document.getElementById('cartTotal').innerText;
            alert(`Proceeding with Binance Payment using ${currency}. Total: ${total}. \n(Simulated: Payment initiated. Cart cleared.)`);
            closeBinanceCryptoPopup();
            // Clear cart upon simulated payment
            cart = [];
            localStorage.removeItem('cart');
            updateCart();
            document.getElementById('cart').style.display = 'none';
        }
        // --- END BINANCE CRYPTO POPUP FUNCTIONS ---

        // --- TRUST WALLET CRYPTO POPUP FUNCTIONS (NEW) ---
        function showTrustWalletCryptoPopup() {
            closePaymentPopup(); // Hide the first popup
            document.getElementById('trustWalletCryptoPopup').style.display = 'block';
        }

        function closeTrustWalletCryptoPopup() {
            document.getElementById('trustWalletCryptoPopup').style.display = 'none';
            showPaymentPopup(); // Go back to the main payment options
        }

        function processTrustWalletPayment(currency) {
            const total = document.getElementById('cartTotal').innerText;
            alert(`Proceeding with Trust Wallet Payment using ${currency}. Total: ${total}. \n(Simulated: Payment initiated. Cart cleared.)`);
            closeTrustWalletCryptoPopup();
            // Clear cart upon simulated payment
            cart = [];
            localStorage.removeItem('cart');
            updateCart();
            document.getElementById('cart').style.display = 'none';
        }
        // --- END TRUST WALLET CRYPTO POPUP FUNCTIONS ---


        // --- Auth Functions (Omitted for brevity, assumed to be correct) ---
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerText = '';

            const hashedPassword = hashPassword(password);
            const user = users.find(u => u.email === email && u.passwordHash === hashedPassword);

            if (user) {
                currentUser = { email: user.email, displayName: user.displayName, isAdmin: user.isAdmin };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                alert('Login successful!');
                closeLogin();
                updateNav();
                return true;
            } else {
                errorDiv.innerText = 'Invalid email or password.';
                return false;
            }
        }

        function toggleSignup() {
            const nameField = document.getElementById('displayName');
            const button = document.getElementById('loginSignupBtn');
            const isSignupMode = nameField.style.display === 'block';

            nameField.style.display = isSignupMode ? 'none' : 'block';
            button.innerText = isSignupMode ? 'Login' : 'Sign Up';
        }

        function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const displayName = document.getElementById('displayName').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerText = '';

            if (!email || !password || !displayName) {
                errorDiv.innerText = 'All fields are required for signup.';
                return false;
            }

            if (users.find(u => u.email === email)) {
                errorDiv.innerText = 'User with this email already exists.';
                return false;
            }

            const hashedPassword = hashPassword(password);
            const newUser = { email, passwordHash: hashedPassword, displayName, isAdmin: false };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));

            currentUser = { email: newUser.email, displayName: newUser.displayName, isAdmin: newUser.isAdmin };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            alert('Signup successful! You are now logged in.');
            closeLogin();
            updateNav();
            return true;
        }

        function handleLoginSignup() {
            if (document.getElementById('displayName').style.display === 'block') {
                signup();
            } else {
                login();
            }
        }


        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            alert('Logged out successfully.');
            closeProfile();
            updateNav();
        }

        function updateProfile() {
            if (!currentUser) return;
            const newName = document.getElementById('updateName').value;
            
            if (newName) {
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex].displayName = newName;
                    currentUser.displayName = newName;
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    alert('Profile updated!');
                    showProfile();
                }
            } else {
                alert('Display name cannot be empty.');
            }
        }

        function requestReset() {
            const email = document.getElementById('resetEmail').value;
            const errorDiv = document.getElementById('forgotError');
            errorDiv.innerText = '';
            
            const user = users.find(u => u.email === email);
            if (!user) {
                errorDiv.innerText = 'Email not found.';
                return;
            }

            const token = Math.random().toString(36).substring(2, 10);
            resetTokens[email] = token;
            localStorage.setItem('resetTokens', JSON.stringify(resetTokens));
            
            alert(`Password reset token generated: ${token}. In a real app, this would be emailed to you.`);

            document.getElementById('resetToken').style.display = 'block';
            document.getElementById('newPassword').style.display = 'block';
            document.querySelector('#forgot button:first-of-type').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'block';
        }

        function resetPassword() {
            const email = document.getElementById('resetEmail').value;
            const token = document.getElementById('resetToken').value;
            const newPassword = document.getElementById('newPassword').value;
            const errorDiv = document.getElementById('forgotError');
            errorDiv.innerText = '';

            const userIndex = users.findIndex(u => u.email === email);
            
            if (userIndex === -1) {
                errorDiv.innerText = 'User not found.';
                return;
            }
            
            if (!resetTokens[email] || resetTokens[email] !== token) {
                errorDiv.innerText = 'Invalid or expired reset token.';
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.innerText = 'New password must be at least 6 characters.';
                return;
            }

            users[userIndex].passwordHash = hashPassword(newPassword);
            delete resetTokens[email];

            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('resetTokens', JSON.stringify(resetTokens));

            alert('Password reset successfully! You can now log in.');
            closeForgot();
            showLogin();
        }


        // --- Cart Functions (Modified addToCart) ---

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const cartItem = cart.find(item => item.id === productId);

            if (cartItem) {
                cartItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCart();
            
            // Show the main payment method popup
            showPaymentPopup(); 
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCart();
        }

        function updateCart() {
            const itemsContainer = document.getElementById('cartItems');
            const totalDisplay = document.getElementById('cartTotal');
            const cartNav = document.querySelector('.nav a[onclick="showCart()"]');
            
            let total = 0;
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = 'Cart is empty.';
                cartNav.innerText = 'Cart (0)';
            } else {
                itemsContainer.innerHTML = cart.map(item => {
                    const subtotal = item.price * item.quantity;
                    total += subtotal;
                    return `
                        <div class="cart-item">
                            <span>${item.name} x ${item.quantity}</span>
                            <span>$${subtotal.toFixed(2)}</span>
                            <button onclick="removeFromCart(${item.id})">Remove</button>
                        </div>
                    `;
                }).join('');
                cartNav.innerText = `Cart (${cart.reduce((sum, item) => sum + item.quantity, 0)})`;
            }

            totalDisplay.innerText = `Total: $${total.toFixed(2)}`;
        }
        
        function checkout() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            if (!currentUser) {
                alert('Please log in to proceed to checkout.');
                showLogin();
                return;
            }

            const lineItems = cart.map(item => ({
                price_data: {
                    currency: 'usd',
                    product_data: {
                        name: item.name,
                    },
                    unit_amount: Math.round(item.price * 100), // Stripe uses cents
                },
                quantity: item.quantity,
            }));

            // For this demo:
            alert('Simulating Stripe Checkout...\nTotal amount: ' + document.getElementById('cartTotal').innerText);
            
            // Clear cart upon successful "checkout"
            cart = [];
            localStorage.removeItem('cart');
            updateCart();
            document.getElementById('cart').style.display = 'none';
        }

        // --- Admin Functions (Omitted for brevity, assumed to be correct) ---
        function addProduct() {
            if (!currentUser || !currentUser.isAdmin) {
                document.getElementById('adminError').innerText = 'Unauthorized.';
                return;
            }
            
            const name = document.getElementById('adminName').value;
            const price = parseFloat(document.getElementById('adminPrice').value);
            const category = document.getElementById('adminCategory').value;
            const img = document.getElementById('adminImg').value;
            const desc = document.getElementById('adminDesc').value;
            const errorDiv = document.getElementById('adminError');
            errorDiv.innerText = '';

            if (!name || isNaN(price) || price <= 0 || !category || !img || !desc) {
                errorDiv.innerText = 'All fields must be valid.';
                return;
            }

            const newId = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
            const newProduct = { id: newId, name, price, category, img, desc };
            products.push(newProduct);
            localStorage.setItem('products', JSON.stringify(products));
            
            alert(`Product "${name}" added successfully!`);
            closeAdmin();
            renderProducts();
            
            document.getElementById('adminName').value = '';
            document.getElementById('adminPrice').value = '';
            document.getElementById('adminImg').value = '';
            document.getElementById('adminDesc').value = '';
        }

        // --- Initialization ---
        function updateNav() {
            const loginLink = document.querySelector('.nav a[onclick="showLogin()"]');
            const profileLink = document.querySelector('.nav a[onclick="showProfile()"]');
            const adminLink = document.querySelector('.nav a[onclick="showAdmin()"]');

            if (currentUser) {
                loginLink.innerText = `Welcome, ${currentUser.displayName.split(' ')[0]}`; 
                profileLink.style.display = 'inline';
                adminLink.style.display = currentUser.isAdmin ? 'inline' : 'none';
            } else {
                loginLink.innerText = 'Login/Signup';
                profileLink.style.display = 'none';
                adminLink.style.display = 'none';
            }
        }

        // Add an initial admin user for the demo
        if (!users.find(u => u.email === 'admin@pass.com')) {
            users.push({ 
                email: 'admin@pass.com', 
                passwordHash: hashPassword('admin123'), 
                displayName: 'Admin User', 
                isAdmin: true 
            });
            localStorage.setItem('users', JSON.stringify(users));
        }

        // Call initial functions
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts();
            updateCart();
            updateNav();
        });

    </script>
</body>
</html>